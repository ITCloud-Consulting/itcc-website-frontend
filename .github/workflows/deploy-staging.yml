name: Deploy to staging

on:
  push:
    branches:
      - staging
  workflow_dispatch:

jobs:
  deploy:
    name: Build and Deploy to VPS
    runs-on: ubuntu-latest

    steps:
      # 1Ô∏è‚É£ Checkout repo
      - name: Checkout code
        uses: actions/checkout@v4

      # 2Ô∏è‚É£ Setup Node.js
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      # 3Ô∏è‚É£ Install dependencies & build
      - name: Install & build
        run: |
          npm ci --legacy-peer-deps
          npm run build

      # 4Ô∏è‚É£ Setup SSH key
      - name: Setup SSH key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.DEPLOY_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H ${{ secrets.VPS_HOST }} >> ~/.ssh/known_hosts
      - name: Deploy to server
        run: |
          # Cr√©e le dossier staging sur le serveur
          ssh -i ~/.ssh/id_rsa -o StrictHostKeyChecking=no ${{ secrets.VPS_USER }}@${{ secrets.VPS_HOST }} "
            mkdir -p /var/www/staging/itcc-website-frontend
          "

          # Copie build, public, package.json, package-lock.json
          rsync -avz --delete \
          --exclude='.git' \
          --exclude='.github' \
          --exclude='node_modules' \
          ./ ${{ secrets.VPS_USER }}@${{ secrets.VPS_HOST }}:/var/www/staging/itcc-website-frontend/

          # D√©ploiement PM2
          ssh -i ~/.ssh/id_rsa -o StrictHostKeyChecking=no ${{ secrets.VPS_USER }}@${{ secrets.VPS_HOST }} "
            cd /var/www/staging/itcc-website-frontend

            pm2 stop itcc-website-frontend-staging || true
            rm -rf node_modules
            npm ci --omit=dev --legacy-peer-deps
            pm2 start npm --name itcc-website-frontend-staging -- start -- -p 3001
            pm2 save
          "
      - name: ü©∫ Health check (with retry)
        run: |
          ssh -i ~/.ssh/id_rsa -o StrictHostKeyChecking=no ${{ secrets.VPS_USER }}@${{ secrets.VPS_HOST }} "\
            for i in {1..10}; do \
              echo '‚è≥ Checking health (attempt '$i')...'; \
              if curl -fs http://localhost:3001; then \
                echo '‚úÖ App is healthy!'; exit 0; \
              fi; \
              sleep 10; \
            done; \
            echo '‚ùå App did not become healthy in time'; \
            exit 1 \
          "